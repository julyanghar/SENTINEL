# SENTINEL å¿«é€Ÿå…¥é—¨æŒ‡å—ï¼ˆä¸­æ–‡ç‰ˆï¼‰

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

**SENTINEL** (Sentence-Level Early Intervention) æ˜¯ä¸€ä¸ªç”¨äºç¼“è§£å¤šæ¨¡æ€å¤§å‹è¯­è¨€æ¨¡å‹(MLLMs)ä¸­å¯¹è±¡å¹»è§‰é—®é¢˜çš„é¡¹ç›®ï¼Œè¢« **ICCV 2025** æ¥æ”¶ã€‚

### æ ¸å¿ƒåˆ›æ–°

1. **å¥å­çº§æ—©æœŸå¹²é¢„**: åœ¨æ¯ä¸ªå¥å­ç”Ÿæˆåç«‹å³æ£€æµ‹å¹»è§‰ï¼Œé˜²æ­¢å¹»è§‰ä¼ æ’­
2. **æ— éœ€äººå·¥æ ‡æ³¨**: ä½¿ç”¨æ£€æµ‹å™¨äº¤å‰éªŒè¯è‡ªåŠ¨æ„å»ºåå¥½æ•°æ®
3. **æ¨¡å‹æ— å…³**: æ”¯æŒLLaVAã€Qwen2-VLç­‰å¤šç§è§†è§‰è¯­è¨€æ¨¡å‹

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```
SENTINEL/
â”œâ”€â”€ main.py                    # ğŸš€ ä¸»å…¥å£
â”œâ”€â”€ run/
â”‚   â”œâ”€â”€ run.py                 # è¿è¡Œå…¥å£
â”‚   â””â”€â”€ generate_dataset.py    # â­ æ ¸å¿ƒï¼šæ•°æ®é›†ç”Ÿæˆé€»è¾‘
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ auxiliary/
â”‚   â”‚   â”œâ”€â”€ global_vars.py     # å…¨å±€å˜é‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ dataset.py         # æ•°æ®é›†ç±»
â”‚   â”‚   â””â”€â”€ datastate.py       # æ•°æ®çŠ¶æ€è·Ÿè¸ª
â”‚   â”œâ”€â”€ generator/             # è§†è§‰è¯­è¨€æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ llava.py           # LLaVAå°è£…
â”‚   â”‚   â”œâ”€â”€ qwen2_vl.py        # Qwen2-VLå°è£…
â”‚   â”‚   â””â”€â”€ qwen2_5_vl.py      # Qwen2.5-VLå°è£…
â”‚   â”œâ”€â”€ detector/              # ç›®æ ‡æ£€æµ‹å™¨
â”‚   â”‚   â”œâ”€â”€ grounding_dino.py  # â­ Grounding DINO
â”‚   â”‚   â””â”€â”€ yolo_model.py      # â­ YOLOæ£€æµ‹å™¨
â”‚   â””â”€â”€ others/                # NLPå·¥å…·
â”‚       â”œâ”€â”€ spacy_model.py     # Spacyï¼ˆæŒ‡ä»£æ¶ˆè§£ç­‰ï¼‰
â”‚       â”œâ”€â”€ wordnet.py         # WordNetï¼ˆåŒä¹‰è¯ï¼‰
â”‚       â””â”€â”€ sg_parser.py       # åœºæ™¯å›¾è§£æ
â””â”€â”€ utils/
    â””â”€â”€ setup_utils.py         # é…ç½®å’Œå‚æ•°è§£æ
```

---

## ğŸ”„ æ ¸å¿ƒç®—æ³•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SENTINEL æ•°æ®ç”Ÿæˆæµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è¾“å…¥: å›¾åƒ + é—®é¢˜ï¼ˆå¦‚"æè¿°è¿™å¼ å›¾ç‰‡"ï¼‰                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           è¿­ä»£ç”Ÿæˆå¾ªç¯                     â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 1. VLMé‡‡æ ·ç”Ÿæˆ10ä¸ªå€™é€‰å¥å­          â”‚  â”‚
        â”‚  â”‚    (temperature=0.7)                â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                    â”‚                      â”‚
        â”‚                    â–¼                      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 2. æŒ‡ä»£æ¶ˆè§£                         â”‚  â”‚
        â”‚  â”‚    "He" â†’ "The man"                 â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                    â”‚                      â”‚
        â”‚                    â–¼                      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 3. å¯¹è±¡æå–                         â”‚  â”‚
        â”‚  â”‚    - MSCOCOè¯è¡¨åŒ¹é…                 â”‚  â”‚
        â”‚  â”‚    - åœºæ™¯å›¾è§£æ                     â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                    â”‚                      â”‚
        â”‚                    â–¼                      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 4. å¹»è§‰æ£€æµ‹ â­å…³é”®æ­¥éª¤              â”‚  â”‚
        â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
        â”‚  â”‚    â”‚ YOLOâœ“ + DINOâœ“ â†’ éå¹»è§‰     â”‚  â”‚  â”‚
        â”‚  â”‚    â”‚ YOLOâœ— + DINOâœ— â†’ å¹»è§‰       â”‚  â”‚  â”‚
        â”‚  â”‚    â”‚ å…¶ä»–æƒ…å†µ â†’ ä¸ç¡®å®š           â”‚  â”‚  â”‚
        â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                    â”‚                      â”‚
        â”‚                    â–¼                      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 5. æ„å»ºåå¥½å¯¹                       â”‚  â”‚
        â”‚  â”‚    y_win = éå¹»è§‰å¥å­              â”‚  â”‚
        â”‚  â”‚    y_lose = å¹»è§‰å¥å­               â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                    â”‚                      â”‚
        â”‚                    â–¼                      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 6. é€‰æ‹©æœ€ä½³å¥å­æ›´æ–°ä¸Šä¸‹æ–‡           â”‚  â”‚
        â”‚  â”‚    ä¼˜å…ˆé€‰æ‹©æ¢ç´¢æ–°å¯¹è±¡çš„å¥å­         â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                    â”‚                      â”‚
        â”‚         å¦‚æœ>50%å€™é€‰ä¸ºç©º â†’ ç»“æŸ          â”‚
        â”‚                    â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è¾“å‡º:                                                   â”‚
    â”‚  - <model_name>.jsonl: å®Œæ•´ç”Ÿæˆç»“æœ                      â”‚
    â”‚  - <model_name>_data_pair.jsonl: DPOè®­ç»ƒåå¥½å¯¹           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/pspdada/SENTINEL.git
cd SENTINEL

# åˆ›å»ºç¯å¢ƒ
conda create -n SENTINEL python=3.10
conda activate SENTINEL

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
pip install -U flash-attn --no-build-isolation
```

### 2. ä¸‹è½½æ•°æ®

- ä¸‹è½½ [Visual Genome](https://homes.cs.washington.edu/~ranjay/visualgenome/api.html) å›¾åƒ
- ä¸‹è½½ [image_data.jsonl](https://huggingface.co/datasets/psp-dada/SENTINEL/blob/main/image_data.jsonl) åˆ° `dataset/`

### 3. ç”Ÿæˆè®­ç»ƒæ•°æ®

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆQwen2_VL_2Bï¼‰
python main.py

# æŒ‡å®šå…¶ä»–æ¨¡å‹
python main.py --model LLaVA_v1_5_7b

# è°ƒæ•´æ‰¹å¤„ç†å¤§å°ï¼ˆæ ¹æ®GPUæ˜¾å­˜ï¼‰
python main.py --batch_size 10
```

### 4. è½¬æ¢ä¸ºè®­ç»ƒæ ¼å¼

```bash
# è½¬æ¢ä¸ºLLaMA-Factoryæ ¼å¼ï¼ˆç”¨äºLLaVA-v1.6, Qwen2-VLç­‰ï¼‰
python utils/get_llama_factory_data_pair.py

# è½¬æ¢ä¸ºLLaVA-v1.5æ ¼å¼
python utils/get_llava_v15_data_pair.py
```

---

## ğŸ”§ å…³é”®é…ç½®

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--model` | `Qwen2_VL_2B` | ä½¿ç”¨çš„VLMæ¨¡å‹ |
| `--batch_size` | `5` | æ‰¹å¤„ç†å¤§å° |
| `--num_of_data` | `-1` | å¤„ç†æ•°æ®é‡ï¼ˆ-1è¡¨ç¤ºå…¨éƒ¨ï¼‰ |
| `--dataset_path` | `dataset/image_data.jsonl` | æ•°æ®é›†è·¯å¾„ |

### æ”¯æŒçš„æ¨¡å‹

- LLaVA_v1_5_7b / LLaVA_v1_5_13b
- LLaVA_v1_6_vicuna_7b / LLaVA_v1_6_vicuna_13b
- Qwen2_VL_2B / Qwen2_VL_7B
- Qwen2_5_VL_7B

---

## ğŸ“Š è¾“å‡ºæ•°æ®æ ¼å¼

### åå¥½å¯¹æ ¼å¼ (`_data_pair.jsonl`)

```json
{
    "image_id": "2345678",
    "image_path": "/path/to/image.jpg",
    "question": "Describe this image in detail.",
    "context": "A dog is sitting on the grass.",
    "y_win": "A cat is playing nearby.",
    "y_lose": "A lion is hunting in the background."
}
```

- `context`: ä¹‹å‰é€‰æ‹©çš„å¥å­ç´¯ç§¯å½¢æˆçš„ä¸Šä¸‹æ–‡
- `y_win`: éå¹»è§‰å¥å­ï¼ˆæ¨¡å‹åº”è¯¥å­¦ä¹ ç”Ÿæˆçš„ï¼‰
- `y_lose`: å¹»è§‰å¥å­ï¼ˆæ¨¡å‹åº”è¯¥å­¦ä¹ é¿å…çš„ï¼‰

---

## ğŸ§  æ ¸å¿ƒä»£ç è§£è¯»

### å¹»è§‰æ£€æµ‹é€»è¾‘

```python
# ç®€åŒ–ç‰ˆå¹»è§‰æ£€æµ‹é€»è¾‘
for obj in objects:
    # YOLOæ£€æµ‹
    yolo_ok = (obj in yolo_results) or (obj not in yolo_labels)
    
    # DINOæ£€æµ‹
    dino_ok = dino.detect(image, obj) is not None
    
    # äº¤å‰éªŒè¯
    if yolo_ok and dino_ok:
        nonhallu_objects.append(obj)  # éå¹»è§‰
    elif not yolo_ok and not dino_ok:
        hallu_objects.append(obj)      # å¹»è§‰
    else:
        uncertain_objects.append(obj)  # ä¸ç¡®å®š
```

### åå¥½å¯¹æ„å»ºé€»è¾‘

```python
# åˆ†ç±»å€™é€‰å¥å­
for sent in candidates:
    objects = extract_objects(sent)
    if has_hallucination(objects):
        hallu_candidates.append(sent)
    else:
        nonhallu_candidates.append(sent)

# æ„å»ºåå¥½å¯¹
for win, lose in zip(nonhallu_candidates, hallu_candidates):
    pairs.append({
        "context": current_context,
        "y_win": win,
        "y_lose": lose
    })
```

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

- [å®Œæ•´ä»£ç æ³¨é‡Šæ–‡æ¡£](./CODE_DOCUMENTATION.md)
- [å¸¦æ³¨é‡Šçš„æ ¸å¿ƒä»£ç ](./src_annotated/)
- [å®˜æ–¹è¯„ä¼°æŒ‡å—](./docs/Evaluation.md)
- [LLaMA-Factoryè®­ç»ƒæŒ‡å—](./llamafactory/README.md)

---

## ğŸ™ å¼•ç”¨

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·å¼•ç”¨ï¼š

```bibtex
@article{peng2025mitigating,
  title={Mitigating Object Hallucinations via Sentence-Level Early Intervention},
  author={Peng, Shangpin and Yang, Senqiao and Jiang, Li and Tian, Zhuotao},
  journal={arXiv preprint arXiv:2507.12455},
  year={2025}
}
```

---

## â“ å¸¸è§é—®é¢˜

**Q: æ˜¾å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ**
A: å‡å° `--batch_size`ï¼Œæˆ–ä½¿ç”¨è¾ƒå°çš„æ¨¡å‹ï¼ˆå¦‚ `Qwen2_VL_2B`ï¼‰

**Q: å¦‚ä½•ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼Ÿ**
A: å‡†å¤‡JSONLæ ¼å¼æ–‡ä»¶ï¼ŒåŒ…å« `image_id`, `image_path`, `question` å­—æ®µ

**Q: ç”Ÿæˆä¸­æ–­åå¦‚ä½•ç»§ç»­ï¼Ÿ**
A: ç›´æ¥é‡æ–°è¿è¡Œï¼Œç¨‹åºä¼šè‡ªåŠ¨è·³è¿‡å·²å¤„ç†çš„æ•°æ®ï¼ˆæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼‰
